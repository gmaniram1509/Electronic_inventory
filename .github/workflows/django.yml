name: Deploy to AWS EC2

# Trigger: When code is pushed to main branch
on:
  push:
    branches: [ main ]

  # Allow manual trigger from GitHub UI
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout code from repository
      - name: Checkout code
        uses: actions/checkout@v3

      # Step 2: Deploy to EC2 via SSH
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            # Navigate to project
            cd /var/www/inventory

            # Stop Gunicorn
            sudo systemctl stop gunicorn

            # Pull latest code
            git pull origin main

            # Activate virtual environment
            source venv/bin/activate

            # Install/update dependencies
            pip install -r requirements.txt

            # Run database migrations
            cd inventory_project
            python manage.py migrate

            # Collect static files
            python manage.py collectstatic --noinput

            # Restart services
            sudo systemctl start gunicorn
            sudo systemctl restart nginx

            # Show status
            sudo systemctl status gunicorn

      # Step 3: Notify on completion
      - name: Deployment Status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "✅ Deployment successful!"
          else
            echo "❌ Deployment failed!"
          fi
